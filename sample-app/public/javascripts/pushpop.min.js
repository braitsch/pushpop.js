function PushPop(e){function i(e){return o(e)?("fixed size"==d.mode?d.width=$(this).val():"fixed ratio"==d.mode&&(d.ratio.width=$(this).val()),!0):!1}function t(e){return o(e)?("fixed size"==d.mode?d.height=$(this).val():"fixed ratio"==d.mode&&(d.ratio.height=$(this).val()),!0):!1}function o(e){if(4==$(e.target).val().toString().length)return!1;var i=window.event?e.keyCode:e.which;return 8===i||46===i||37===i||39===i?!0:!(48>i||i>57)}var a={upload:"/upload","delete":"/delete"},s=void 0;e&&(e.api&&(a.upload=e.api.upload,a["delete"]=e.api["delete"]),e.maxFileSize&&(s=e.maxFileSize));var d={mode:"normal",width:100,height:100,ratio:{width:16,height:9}};this.openPushModal=function(){h.modal("show")},this.openPopModal=function(e){var i=$(e).data("meta");r.data("id",i._id);var t=$(".modal-pop .media-preview img"),o=$(".modal-pop .media-preview iframe");"image"==i.type?(t.show(),t.attr("src",i.host+"/"+i.project+"/"+i.image)):"video"==i.type&&(o.show(),o.attr("src",i.video)),r.modal("show")};var r=$(".modal-pop"),h=$(".modal-push"),n=$(".modal-push #image form"),u=$(".modal-push #video form"),l=$(".modal-push .media-preview img"),m=$(".modal-push .media-preview iframe"),p=$(".modal-push .file-dialog"),c=$(".modal-push .progress"),f=$(".modal-push .thumb-settings"),v=$(".modal-push .media-dropdown"),g=$(".modal-push #image .media-input"),w=$(".modal-push #video .media-input"),b=$(".modal-push .btn-select"),y=($(".modal-push .btn-upload"),$(".modal-push .btn-save-video"),$(".modal-push .instructions")),x={width:0,height:0},k={url:"",preview:""};v.change(function(e){T(),"image"==this.value.toLowerCase()?($("#image").show(),$("#video").hide(),l.show(),m.hide(),c.show(),f.show(),void 0!=l.attr("src")&&y.show()):"video"==this.value.toLowerCase()&&($("#image").hide(),$("#video").show(),l.hide(),m.show(),c.hide(),f.hide(),y.hide())}),b.click(function(e){p.click()}),p.change(function(e){if(T(),this.files&&this.files[0])if(s&&this.files[0].size/1e3/1e3>s)alert("The maximum file size for uploads in this demo is "+s+"MB.");else{var i=new FileReader;i.onload=function(e){var i=new Image;i.onload=function(){x.width=i.width,x.height=i.height},i.src=e.target.result,l.attr("src",e.target.result),g.val(p.val().replace(/C:\\fakepath\\/i,""))},i.readAsDataURL(this.files[0]),y.show()}}),n.ajaxForm({url:a.upload,beforeSubmit:function(e,i,t){if(S.width()>0||S.height()>0){var o=x.width/L.width(),a=x.height/L.height();d.crop.x=(S.offset().left-L.offset().left)*o,d.crop.y=(S.offset().top-L.offset().top)*a,d.crop.w=S.width()*o,d.crop.h=S.height()*a,"fixed size"!=d.mode&&(d.width=0,d.height=0),e.push({name:"thumb",value:JSON.stringify(d)})}e.push({name:"type",value:"image"}),console.log("------ sending data ------");for(var s=0;s<e.length;s++){if("file-dialog"==e[s].name&&!e[s].value)return alert("please select an image"),!1;console.log(s,e[s].name,e[s].value)}return!0},uploadProgress:function(e,i,t,o){$(".progress-bar").width(.8*o+"%")},success:function(){$(".progress-bar").width("100%")},complete:function(e){$(".progress-bar").width("100%"),setTimeout(C,500)}}),w.bind("paste",function(e){setTimeout(function(){k.url=w.val(),-1!=k.url.search("youtube")?(k.id=k.url.substring(k.url.lastIndexOf("?v=")+3),k.url="https://www.youtube.com/embed/"+k.id,m.attr("src",k.url),k.preview="https://img.youtube.com/vi/"+k.id+"/hqdefault.jpg"):-1!=k.url.search("vimeo")&&(k.id=k.url.substring(k.url.lastIndexOf("/")+1),k.url="https://player.vimeo.com/video/"+k.id,m.attr("src",k.url),$.get("https://vimeo.com/api/v2/video/"+k.id+".json",function(e){k.preview=e[0].thumbnail_large}))},1)}),u.ajaxForm({url:a.upload,beforeSubmit:function(e,i,t){return e.push({name:"type",value:"video"}),e.push({name:"url",value:k.url}),e.push({name:"preview",value:k.preview}),!0},complete:function(e){setTimeout(C,500)}});var C=function(){h.modal("hide"),h.on("hidden.bs.modal",function(e){location.reload(!0)})},z=function(){r.modal("hide"),r.on("hidden.bs.modal",function(e){location.reload(!0)})};$(".thumb-settings .w").keyup(i),$(".thumb-settings .h").keyup(t),$(".thumb-settings .s1").change(function(e){d.mode=this.value.toLowerCase(),"normal"==d.mode?($(".thumb-settings .w").val(""),$(".thumb-settings .h").val("")):"fixed ratio"==d.mode?($(".thumb-settings .w").val(d.ratio.width),$(".thumb-settings .h").val(d.ratio.height)):"fixed size"==d.mode&&($(".thumb-settings .w").val(d.width),$(".thumb-settings .h").val(d.height)),$(".thumb-settings .w").prop("disabled","normal"==d.mode),$(".thumb-settings .h").prop("disabled","normal"==d.mode)}),$(".thumb-settings .s2").change(function(e){$(".thumb-generator").css("border-color",this.value.toLowerCase())});var L=$(".media-preview img"),S=$(".thumb-generator"),j=$(".media-preview");S.hide(),L.on("dragstart",function(e){e.preventDefault()});var F=parseInt($(".modal-body").css("padding"))+parseInt($(".modal-push .well").css("padding")),T=function(){S.hide(),d.crop={}},I=function(e){var i={x:e.clientX+F,y:e.clientY+F},t={x:j.offset().left-$(window).scrollLeft(),y:j.offset().top-$(window).scrollTop()};return{x:i.x-t.x,y:i.y-t.y}},P=function(e){var i=I(e),t=i.x-d.crop.x,o=i.y-d.crop.y;"fixed ratio"==d.mode&&(o=t*(d.ratio.height/d.ratio.width)),S.css({width:t,height:o})},M=function(e){var i=I(e);d.crop={},d.crop.x=i.x,d.crop.y=i.y,S.css({left:d.crop.x,top:d.crop.y}),"fixed size"!=d.mode?(L.bind("mousemove",P),L.css("cursor","crosshair"),S.css({width:0,height:0})):S.css({width:d.width*(L.width()/x.width),height:d.height*(L.height()/x.height)}),S.show()},O=function(){L.css("cursor","default"),L.unbind("mousemove",P)};$(window).bind("mouseup",O),L.bind("mousedown",M),document.addEventListener("keydown",function(e){S.is(":visible")&&(37==e.keyCode?d.crop.x--:38==e.keyCode?d.crop.y--:39==e.keyCode?d.crop.x++:40==e.keyCode&&d.crop.y++,S.css({left:d.crop.x,top:d.crop.y}))},!1),$(".modal-pop").on("hidden.bs.modal",function(e){var i=$(".modal-pop .media-preview img"),t=$(".modal-pop .media-preview iframe");i.hide(),i.attr("src",""),t.hide(),t.attr("src","")}),$(".modal-pop form").ajaxForm({url:a["delete"],beforeSubmit:function(e,i,t){e.push({name:"id",value:r.data("id")})},complete:function(e){setTimeout(z,500)}})}